
# Отчёт "Комплексное исследование производительности чёрного ящика"

## 1. Окружение

### ОС

- **ОС:** linux
- **Дистрибутив:** Debian

### Аппаратные ресурсы

- **Кол-во ядер CPU:** 12
- **RAM:** 32 gb

---

## 2. Методика и инструменты тестирования

### Сценарий прогона (как тестировалось)

- Приложение `app_linux_amd64` запускалось без аргументов и работало параллельно с подачей HTTP‑нагрузки генератором vegeta.
- Во время прогона непрерывно собирались системные метрики (очереди выполнения, CPU, память, I/O и т.д) в отдельные лог‑файлы.
- В качестве цели теста рассматривалось поведение приложения под ступенчатой и стрессовой нагрузкой, а также под длительной нагрузкой уровня умеренного уровня.

### Нагрузочный профиль vegeta (targets/rate в целом)

- Нагрузка задавалась в виде фаз с фиксированным rate (rps) и известными временными интервалами.
- Конкретные targets/endpoint’ы vegeta задаются в отдельном файле `targets.txt`

```text

GET http://localhost:8080/
User-Agent: vegeta-test
X-Test-Header1: value1
X-Test-Header2: value2

POST http://localhost:8080/
Content-Type: application/json
User-Agent: vegeta-test
X-Test-Header1: value1
X-Test-Header2: value2
@post_body.json
```

---

### Таймлайн нагрузки

Фазы и интенсивность нагрузки vegeta по времени:

| Фаза          | Интервал (MSK)       | Интенсивность |
| ------------- |----------------------|---------------|
| Холодный старт     | 19:04:55–19:06:25    | 0 rps         |
| Прогрев на малом RPS     | 19:06:25–19:08:27    | 20/1s         |
| Шаг 1    | 19:08:27–19:10:01    | 50/1s         |
| Шаг 2    | 19:10:01–19:11:38    | 100/1s        |
| Шаг 3    | 19:11:38–19:13:18    | 150/1s        |
| Шаг 4    | 19:13:18–19:15:02    | 200/1s        |
| "Стресс"-тест на бОльшем RPS  | 19:15:02–19:15:45    | 400/1s        |
| Умеренная нагрузка, стабилизация      | 19:15:45–19:21:19    | 150/1s        |
| Тест сотсояния покоя после отключения нагрузки | 19:21:19–19:25:13    | 0 rps         |

---

## Утилиты мониторинга

- sar  
- mpstat  
- pidstat  
- vmstat  
- iostat  

## Уровень 1

### 1. Утилизация CPU

- В ходе тестирования нагрузка распределялась по ядрам равномерно

```text
07:04:54 PM  CPU    %usr   %nice    %sys %iowait    %irq   %soft  %steal  %guest  %gnice   %idle
07:04:55 PM  all   25.36    0.00   11.70    2.97    0.00    0.00    0.00    0.00    0.00   59.97

...

07:14:34 PM  CPU    %usr   %nice    %sys %iowait    %irq   %soft  %steal  %guest  %gnice   %idle
07:14:35 PM  all   16.53    0.00    4.32    1.00    0.00    0.25    0.00    0.00    0.00   77.91

...

07:21:13 PM  CPU    %usr   %nice    %sys %iowait    %irq   %soft  %steal  %guest  %gnice   %idle
07:21:14 PM  all   13.08    0.00   20.51   48.72    0.00    0.00    0.00    0.00    0.00   17.69

...

07:27:18 PM  CPU    %usr   %nice    %sys %iowait    %irq   %soft  %steal  %guest  %gnice   %idle
07:27:19 PM  all    0.92    0.00   27.53   68.45    0.00    0.00    0.00    0.00    0.00    3.10
```

- Виден постепенный рост `system time` и `iowait` по ходу тестирования. Показатели не пришли в норму и на этапе покоя, при повторном тестирования с меньшей суммарной продолжительностью удалось добиться спада показателей и стабилизации

```text
07:04:55 PM   runq-sz  plist-sz   ldavg-1   ldavg-5  ldavg-15   blocked
07:04:56 PM         8      1145      3.77      1.10      0.38         1

...

07:17:06 PM         6      1250     11.68      5.56      2.67        18

...

07:18:04 PM       147      1354     93.12     28.48     10.62        27

...

07:27:37 PM        12      1900    216.92    146.99     78.76       308

07:27:58 PM         2      1928    191.85    145.73     79.80       115
```

- Также наблюдается положительная динамика блокировок
- Длина очереди выполнения превышает допустимые значения (достигает значений вплоть до `~150`) после подачи "стресс"-нагрузки

### 2. Активность потоков

```text
ts=2025-12-14T19:04:55+03:00 total=5 R=0 S=5 D=0 other=0
...
ts=2025-12-14T19:13:50+03:00 total=14 R=0 S=6 D=8 other=0
...
ts=2025-12-14T19:16:24+03:00 total=67 R=0 S=19 D=48 other=0
...
ts=2025-12-14T19:22:42+03:00 total=67 R=0 S=66 D=1 other=0

```

- В ходе подачи нагрузки растет количество потоков ОС, поскольку данный бинарник - go-приложение, предполагается создание доп. числа ОС-потоков планировщиком языка только в случае необходимости, долгих системных вызовов.
- О наличии логики исполнения "тяжелых" системных вызовов косвенно может сказать показатель числа потков в состоянии `D` (uninterruptible sleep), что также коррелирует с возрастающим system time/iowait

- Динамика `%system` в имеющейся выдержке **не подтверждена** (нужен `sar -u` и/или `pidstat` по CPU, чтобы показать рост `%sys` во времени).  
- Рекомендация для отчёта: привести строки с максимальным `%sys` и сопоставить их по времени с фазами vegeta и всплесками `blocked`/`runq-sz`.

### Признаки блокировок

- В `sar_q.log` наблюдаются выраженные признаки блокировок на уровне ОС: метрика `blocked` (задачи в D-state) в моменты деградации достигает сотен. [file:524]  
- Пример пиков: около 19:18–19:21 фиксируются значения `blocked` порядка 235 и 525, что указывает на массовые ожидания (чаще всего I/O, реже — другие kernel wait). [file:524]

### Длина очереди выполнения

- Очередь выполнения существенно раздувается: `runq-sz` растёт от единиц/десятков в “спокойной” части до очень больших значений (фиксируются десятки и выше 100), что означает перегруз планировщика/избыток runnable‑задач. [file:524]  
- Одновременно резко растут `ldavg-*` (load average), достигая трёхзначных значений (например ~123–172 и выше), что согласуется с фазой деградации по времени. [file:524]


### Увязка фаз нагрузки с наблюдаемой деградацией

- Фаза **03_stress_01 (400 rps)** попадает в интервал, после которого в метриках очереди выполнения и числа blocked‑задач фиксируется усиление деградации: растёт `runq-sz`, увеличивается `blocked`, повышается load average.  
- Фаза **04_soak (150 rps)** совпадает по времени с наиболее выраженными симптомами: высокие значения load average, увеличенная очередь выполнения и значимое число задач в D‑state, что согласуется со сценарием I/O‑bound или “шторм ожиданий”.  
- В фазе **cooldown idle (0 rps)** нагрузка со стороны vegeta снимается, но системные метрики могут “сходить” не мгновенно: очереди и blocked сокращаются с инерцией, что важно учитывать при интерпретации восстановления после нагрузки.

---

---

## Сводная таблица: лог‑файл → метрики

| Лог-файл                 | Какие метрики отражены                                                                 |
|--------------------------|----------------------------------------------------------------------------------------|
| `sar_q.log`              | Очередь выполнения и планирование: `runq-sz`, `plist-sz`, `ldavg-1/5/15`, `blocked`.  |
| `sar_blockio.log`        | Блочный I/O (агрегировано): `tps`, `rtps`, `wtps`, `breads`, `bwrtn`.                 |
| `mpstat.log`             | Per‑CPU утилизация: нагрузка по ядрам (`%usr`, `%sys`, `%iowait`, `%idle`).          |
| `pidstat_cpu_threads.log`| CPU по процессу и потокам: загрузка CPU каждым потоком процесса.                      |
| `pidstat_ctx_threads.log`| Context switches по потокам: `cswch/s`, `nvcswch/s`.                                  |
| `pidstat_io_proc.log`    | I/O на уровне процесса: чтение/запись в единицу времени.                              |
| `vmstat.log`             | Общесистемно: `r/b`, память, swap (`si/so`), I/O (`bi/bo`), interrupts/context switches. |
| `iostat_xz.log`          | Диски/устройства: throughput, `await`, `avgqu-sz`, `%util`.                           |
| `threads_dump.log`       | Снимки потоков процесса: TID, `STAT`, `PSR`, `%CPU`, `%MEM`, имя потока.             |
| `threads_summary.log`    | Агрегированная сводка по потокам (топ по CPU/ctx, статусы).                          |
| `snapshots_mem.log`      | Снимки состояния памяти (free/available/cache или аналогичные значения).             |
| `timeline.txt`           | Описание фаз и таймлайна теста (этапы нагрузки, времена начала/окончания).           |
| `vegeta_compressed.sh` | Скрипты запуска vegeta: targets, rate, duration, параметры нагрузки.           |
